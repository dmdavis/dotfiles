#!/usr/bin/env zsh

set -e

# Location of dotfiles repo
# Using Zsh specific syntax to get the absolute path of the script
DOTFILES=${${(%):-%x}:A:h}

echo "Dotfiles directory: $DOTFILES"

# Files to symlink
files=(".zshrc" ".zshenv" ".zprofile")

for file in $files; do
  target="$HOME/$file"
  source="$DOTFILES/$file"

  if [[ -L "$target" ]]; then
    # It's a symbolic link
    current_link=$(readlink "$target")
    # Handle both relative and absolute links if necessary,
    # but here we expect absolute as we created it with absolute path $DOTFILES/file
    if [[ "$current_link" == "$source" ]]; then
      echo "✅ $file is already correctly symlinked."
    else
      echo "⚠️  $file is a symlink but points to $current_link"
      printf "Update it to point to $source? (y/n) "
      read -k 1 reply
      echo
      if [[ $reply == "y" ]]; then
        ln -sf "$source" "$target"
        echo "Updated $file symlink."
      fi
    fi
  elif [[ -d "$target" ]]; then
    echo "❌ Warning: $target is a directory. Skipping."
  elif [[ -f "$target" ]]; then
    # It's a regular file
    echo "⚠️  $target exists and is a regular file."
    printf "Move it to trash and replace with symlink? (y/n) "
    read -k 1 reply
    echo
    if [[ $reply == "y" ]]; then
      if [[ "$OSTYPE" == "darwin"* ]]; then
        if command -v trash >/dev/null 2>&1; then
          trash "$target"
        else
          echo "trash command not found, using mv $target ${target}.bak"
          mv "$target" "${target}.bak"
        fi
      else
        echo "Not on macOS, using mv $target ${target}.bak"
        mv "$target" "${target}.bak"
      fi
      ln -s "$source" "$target"
      echo "Created symlink for $file."
    fi
  else
    # File doesn't exist
    echo "Creating symlink for $file."
    ln -s "$source" "$target"
  fi
done

